# 创建对象的方法

1. 使用关键字new创建
2. 使用Class的newInstance()
3. Constructor的newInstance()方法
4. 使用clone()
5. 使用反序列化
6. 第三方类库

上面这些大致能分为两类：一个是走了类的构造方法，另一种是不走类的构造方法。

# 创建对象的步骤

大致分为一下几个步骤

1. 判断对象对应的类是否加载、如果没有加载就调用加载器加载
2. 为对象分配内存
3. 处理并发安全问题
4. 初始化分配到的空间
5. 设置对象的对象头
6. 执行init方法进行初始化

## 为对象分配内存

### 计算内存的方法

如果对象的属性是引用类型，占4个字节

基本数据类型除双精度和长整型同样占四个字节，双精度和长整型占8个字节。

### 分配策略

如果是内存是规整的，使用指针碰撞的方法为对象分配内存。

这种方法只需要维护一个指针，指向未使用和已使用的内存的分割点，常见于使用标记整理算法的空间

如果内存不规整，则使用空闲列表分配的方法分配

在这种情况下，未使用的内存是不连续的，需要维护一个列表，记录未使用的空间，在分配内存之后需要更新列表，常见于使用标记清除算法的空间

## 处理并发安全问题

采用cas算法加上失败重试保证更新的原子性

每个线程预先分配TLAB



## 初始化分配到的空间

在这个阶段会将对象的属性进行初始化，经过这个阶段之后，属性已经可以使用了，但是其值是默认值。



## 设置对象的对象头

对象头一般包含以下信息：

1. 对象在堆中的地址
2. 对象对应的类在方法区的地址
3. GC信息
4. 线程锁的信息
5. 对象的HashCode
6. 如果创建的是数组，还会额外保存数组的长度



# 对象的内存布局

主要包含以下几种数据：

1. 对象头
2. 实例数据
3. 对齐填充

## 实例数据

主要包含对象定义的各种类型的字段，包含本身拥有的字段和从父类继承的字段

存放的时候有以下的规则：

1. 相同宽度的字段总是被分配在一起
2. 父类中定义的变量会出现在子类之前
3. 如果CompactFields参数被设置为true，子类的窄变量可能会被插入到父类变量的空隙

# 对象访问

对象的属性值只是一个指向其在堆中的地址的引用，并非是直接存储对象的信息，

## 句柄访问

在堆中额外维护一个句柄，包含指向对象实例数据和类数据的引用；对象的属性值指向此句柄。

## 直接指针

对象的属性，直接指向对象在堆中的地址，对象中额外维护一个指针，指向对象的类型数据。

## 优缺点

句柄访问需要二次寻址，访问速度可能没有直接指针块。

在GC的时候，对象的位置发生变化的时候，如果是句柄的形式，更改句柄的引用即可，无需更改属性的指向。